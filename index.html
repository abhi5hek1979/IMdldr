<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robust Image Scraper</title>
    <style>
        /* --- STYLES --- */
        body {
            font-family: sans-serif;
            background-color: #121212;
            color: #eee;
            margin: 0;
            padding: 15px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        h2 { color: #bb86fc; text-align: center; margin-top: 0; }

        .input-group { margin-bottom: 15px; }
        
        label {
            font-size: 12px;
            color: #aaa;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background-color: #2c2c2c;
            color: white;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 14px;
            background-color: #03dac6;
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:disabled { background-color: #555; color: #888; }

        #status { 
            margin: 15px 0; 
            font-size: 13px; 
            background: #252525;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #333;
            min-height: 20px;
            font-family: monospace; 
            white-space: pre-wrap; /* Keeps log lines separate */
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .img-card {
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #333;
            position: relative;
        }

        .img-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .download-btn-small {
            width: 100%;
            padding: 8px;
            background-color: #333;
            color: #bb86fc;
            font-size: 12px;
            border: none;
            border-top: 1px solid #444;
            border-radius: 0;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>Robust Scraper V3</h2>
        
        <div class="input-group">
            <label>Target Website URL</label>
            <input type="text" id="siteUrl" placeholder="https://www.wikipedia.org">
        </div>

        <button id="scanBtn">Scan Page</button>
        
        <div id="status">Ready to scan...</div>

        <div class="image-grid" id="grid"></div>
    </div>

    <script>
        const scanBtn = document.getElementById('scanBtn');
        const siteUrlInput = document.getElementById('siteUrl');
        const statusDiv = document.getElementById('status');
        const grid = document.getElementById('grid');

        // Helper to log messages to the screen
        function log(msg, isError = false) {
            statusDiv.innerText = msg;
            statusDiv.style.color = isError ? "#ff6b6b" : "#eee";
        }

        scanBtn.addEventListener('click', async () => {
            let url = siteUrlInput.value.trim();
            
            if (!url) { log("Please enter a URL first.", true); return; }
            if (!url.startsWith('http')) { url = 'https://' + url; siteUrlInput.value = url; }

            grid.innerHTML = ''; 
            scanBtn.disabled = true;
            
            // ATTEMPT 1: AllOrigins Proxy
            log(`Attempting Server 1 (AllOrigins)...`);
            
            try {
                const content = await fetchViaAllOrigins(url);
                processHtml(content, url);
            } catch (err1) {
                console.error(err1);
                
                // ATTEMPT 2: CorsProxy.io
                log(`Server 1 blocked. Trying Server 2 (CorsProxy)...`);
                
                try {
                    const content2 = await fetchViaCorsProxy(url);
                    processHtml(content2, url);
                } catch (err2) {
                    console.error(err2);
                    log(`❌ FAILED. \nBoth servers were blocked by the target site.\nReason: ${err2.message}`, true);
                    scanBtn.disabled = false;
                }
            }
        });

        // --- PROXY METHOD 1 ---
        async function fetchViaAllOrigins(targetUrl) {
            const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`);
            const data = await response.json();
            if (!response.ok) throw new Error("Network Error");
            if (!data.contents) throw new Error("Empty Response");
            return data.contents;
        }

        // --- PROXY METHOD 2 ---
        async function fetchViaCorsProxy(targetUrl) {
            // This proxy returns raw HTML directly
            const response = await fetch(`https://corsproxy.io/?` + encodeURIComponent(targetUrl));
            if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
            return await response.text();
        }

        // --- PROCESSING LOGIC ---
        function processHtml(htmlString, baseUrl) {
            log("HTML received! extracting images...");
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const imgTags = doc.querySelectorAll('img');

            if (imgTags.length === 0) {
                log("✅ Scan complete, but NO images found in the code.");
                scanBtn.disabled = false;
                return;
            }

            let count = 0;
            imgTags.forEach(img => {
                let src = img.getAttribute('src');
                if (!src) return;

                // Fix URL formatting
                if (src.startsWith('//')) src = 'https:' + src;
                else if (src.startsWith('/')) src = new URL(baseUrl).origin + src;
                else if (!src.startsWith('http')) src = baseUrl + '/' + src;

                // Basic Filter: Ignore tiny tracking pixels (heuristic)
                // We can't check real size yet, so we display everything reasonable
                createImageCard(src);
                count++;
            });

            log(`✅ Success! Found ${count} images.`);
            scanBtn.disabled = false;
        }

        function createImageCard(url) {
            const div = document.createElement('div');
            div.className = 'img-card';
            div.innerHTML = `
                <img src="${url}" onerror="this.parentElement.style.display='none'">
                <button class="download-btn-small" onclick="downloadOne('${url}')">Download</button>
            `;
            grid.appendChild(div);
        }

        function downloadOne(url) {
            const a = document.createElement('a');
            a.href = url;
            a.download = 'image.jpg';
            a.target = '_blank';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>

</body>
</html>
