<!DOCTYPE html>
<html>
<head>
  <title>Image Filter PWA</title>
  <link rel="manifest" href="manifest.json">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('service-worker.js');
    });
  }
  </script>
  <style>
    body { font-family: sans-serif; margin: 1em; }
    .grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top:1em;}
    .img-box { width: 200px; margin-bottom: 10px; }
    img { width: 100%; height: auto; display: block; }
    input, button { margin-right:0.5em; margin-bottom:0.5em; }
  </style>
</head>
<body>
  <h1>Image Filter PWA</h1>
  <input type="text" id="urlInput" placeholder="Enter page URL"><br>
  <input type="number" id="sizeInput" placeholder="Min size (KB)">
  <input type="number" id="widthInput" placeholder="Min width (px)">
  <button onclick="fetchImages()">Fetch Images</button>
  <div id="gallery" class="grid"></div>
  <script>
  async function fetchImages() {
    const url = document.getElementById('urlInput').value;
    const minKB = parseInt(document.getElementById('sizeInput').value) || 0;
    const minWidth = parseInt(document.getElementById('widthInput').value) || 0;
    document.getElementById('gallery').innerHTML = 'Loading...';
    try {
      let res = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url));
      let html = await res.text();
      let images = Array.from(html.matchAll(/<img[^>]+src=["']([^"']+)["']/g)).map(m => m[1]);
      let gallery = document.getElementById('gallery');
      gallery.innerHTML = '';
      for (let src of images) {
        if (!/^https?:///.test(src)) { src = new URL(src, url).href; }
        try {
          let imgRes = await fetch(src);
          let blob = await imgRes.blob();
          if (blob.size < minKB * 1024) continue;
          let imgObj = document.createElement('img');
          let objectURL = URL.createObjectURL(blob);
          imgObj.src = objectURL;
          await new Promise(r => imgObj.onload = r);
          if (imgObj.width < minWidth) continue;
          let box = document.createElement('div');
          box.className = 'img-box';
          box.appendChild(imgObj);
          let dlBtn = document.createElement('button');
          dlBtn.textContent = 'Download';
          dlBtn.onclick = () => {
            let a = document.createElement('a');
            a.href = objectURL;
            a.download = src.split('/').pop();
            a.click();
          };
          box.appendChild(dlBtn);
          gallery.appendChild(box);
        } catch(e) { continue; }
      }
    } catch (err) {
      document.getElementById('gallery').textContent = 'Failed to load images.';
    }
  }
  </script>
</body>
</html>
